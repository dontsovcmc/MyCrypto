<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Taking keys apart &mdash; MyCrypto 1.0 documentation</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="MyCrypto 1.0 documentation" href="index.html" />
    <link rel="next" title="Standard key formats" href="formats.html" />
    <link rel="prev" title="Example using openssl" href="openssl.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="formats.html" title="Standard key formats"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="openssl.html" title="Example using openssl"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">MyCrypto 1.0 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="taking-keys-apart">
<span id="structure"></span><h1>Taking keys apart<a class="headerlink" href="#taking-keys-apart" title="Permalink to this headline">¶</a></h1>
<p><strong>Key structure</strong></p>
<p>In this chapter we make an attempt to explore the inside structure of public/private key pairs.  A difficulty here is that there are lots of different formats.  We don&#8217;t need to (and won&#8217;t) understand all of them, but I&#8217;d just like to get some idea of how the data is arranged for a few examples.</p>
<p>I will use the Python <tt class="docutils literal"><span class="pre">rsa</span></tt> module to generate very short keys to make it easier to see what’s what.  Use <tt class="docutils literal"><span class="pre">pip</span></tt> to install rsa in the usual way.</p>
<p>I picked a couple of very small prime numbers.  Start by entering the following values</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">rsa</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span> <span class="o">=</span> <span class="mi">151</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">q</span> <span class="o">=</span> <span class="mi">211</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">n</span> <span class="o">=</span> <span class="n">p</span><span class="o">*</span><span class="n">q</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">n</span>
<span class="go">31861</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">e</span> <span class="o">=</span> <span class="mi">17</span>
<span class="go">&gt;&gt;&gt;</span>
</pre></div>
</div>
<p>The only numbers we need for a public key are <em>n</em> and <em>e</em>.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">pbk</span> <span class="o">=</span> <span class="n">rsa</span><span class="o">.</span><span class="n">PublicKey</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span><span class="n">e</span><span class="o">=</span><span class="n">e</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pbk</span>
<span class="go">PublicKey(31861, 17)</span>
<span class="go">&gt;&gt;&gt;</span>
</pre></div>
</div>
<p>We can write the data to disk or just look at it from within Python:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">data</span> <span class="o">=</span> <span class="n">pbk</span><span class="o">.</span><span class="n">save_pkcs1</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">data</span>
<span class="go">-----BEGIN RSA PUBLIC KEY-----</span>
<span class="go">MAcCAnx1AgER</span>
<span class="go">-----END RSA PUBLIC KEY-----</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">b64</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">b64</span>
<span class="go">u&#39;MAcCAnx1AgER&#39;</span>
<span class="go">&gt;&gt;&gt;</span>
</pre></div>
</div>
<p>Next we have to decode the <tt class="docutils literal"><span class="pre">base64</span></tt></p>
<p><a class="reference external" href="http://en.wikipedia.org/wiki/Base64">http://en.wikipedia.org/wiki/Base64</a></p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">base64</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">h</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">b64</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">h</span>
<span class="go">&#39;0\x07\x02\x02|u\x02\x01\x11&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">L</span> <span class="o">=</span> <span class="p">[</span><span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">h</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">L</span>
<span class="go">[48, 7, 2, 2, 124, 117, 2, 1, 17]</span>
<span class="go">&gt;&gt;&gt;</span>
</pre></div>
</div>
<p>(I always have to re-learn this stuff when I do it.  The string <tt class="docutils literal"><span class="pre">h</span></tt> above is how Python represents binary data.  If the character isn&#8217;t printably you get something like <tt class="docutils literal"><span class="pre">\x02</span></tt>, but if it is, you get the character, like <tt class="docutils literal"><span class="pre">|</span></tt>.  In contrast, if you want to see all hex data as a string do <tt class="docutils literal"><span class="pre">[hex(c)</span> <span class="pre">for</span> <span class="pre">c</span> <span class="pre">in</span> <span class="pre">L]</span></tt> after the last step, when <tt class="docutils literal"><span class="pre">L</span></tt> contains integers).</p>
<p>The layout seems to be that each region of the data consists of a byte that gives a code for the type of value, then the size of the value, then the value itself. For example <tt class="docutils literal"><span class="pre">2,2,124,117</span></tt> is an integer value of length 2 bytes, and the actual number is 124*256 + 117 which is equal to</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="mi">124</span><span class="o">*</span><span class="mi">256</span> <span class="o">+</span> <span class="mi">117</span>
<span class="go">31861</span>
</pre></div>
</div>
<p>which is just <em>n</em>. Similarly, <tt class="docutils literal"><span class="pre">2,1,17</span></tt> is <em>e</em>. The leading terms <tt class="docutils literal"><span class="pre">48,7</span></tt> obviously describes the format, but I don&#8217;t know the details of what it means at the moment.</p>
<p>If we are to generate a private key, we will need an additional number.  First we compute φ(n):</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">phi</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">q</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">phi</span>
<span class="go">31500</span>
<span class="go">&gt;&gt;&gt;</span>
</pre></div>
</div>
<p>and then we find <em>d</em>, the modular multiplicative inverse of <em>e</em>.  I won&#8217;t show it again but I used the code shown in the first chapter to do this</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">d</span> <span class="o">=</span> <span class="n">modinv</span><span class="o">.</span><span class="n">modinv</span><span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="n">phi</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">d</span>
<span class="go">1853</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">d</span><span class="o">*</span><span class="n">e</span> <span class="o">%</span> <span class="n">phi</span>
<span class="go">1</span>
<span class="go">&gt;&gt;&gt;</span>
</pre></div>
</div>
<p>So, given these five numbers, we can generate a private key:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">pk</span> <span class="o">=</span> <span class="n">rsa</span><span class="o">.</span><span class="n">PrivateKey</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">31861</span><span class="p">,</span><span class="n">e</span><span class="o">=</span><span class="mi">17</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="mi">151</span><span class="p">,</span><span class="n">q</span><span class="o">=</span><span class="mi">211</span><span class="p">,</span><span class="n">d</span><span class="o">=</span><span class="mi">1853</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">data</span> <span class="o">=</span> <span class="n">pk</span><span class="o">.</span><span class="n">save_pkcs1</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">b64</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">b64</span>
<span class="go">u&#39;MCACAQACAnx1AgERAgIHPQICAJcCAgDTAgE1AgIArQIBSQ==&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">h</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">b64</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">L</span> <span class="o">=</span> <span class="p">[</span><span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">h</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">L</span><span class="p">[:</span><span class="mi">17</span><span class="p">]</span>
<span class="go">[48, 32, 2, 1, 0, 2, 2, 124, 117, 2, 1, 17, 2, 2, 7, 61, 2]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">L</span><span class="p">[</span><span class="mi">17</span><span class="p">:]</span>
<span class="go">[2, 0, 151, 2, 2, 0, 211, 2, 1, 53, 2, 2, 0, 173, 2, 1, 73]</span>
<span class="go">&gt;&gt;&gt;</span>
</pre></div>
</div>
<p>So what we have is some kind of introductory header of <tt class="docutils literal"><span class="pre">48,32</span></tt>, then <tt class="docutils literal"><span class="pre">2,1,0</span></tt> (not sure about that), then <tt class="docutils literal"><span class="pre">2,2,124,117</span></tt> which as before is <em>n</em>, then <tt class="docutils literal"><span class="pre">2,1,17</span></tt> which is <em>e</em>, followed by <tt class="docutils literal"><span class="pre">2,2,7,61</span></tt>.  This number is</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="mi">7</span><span class="o">*</span><span class="mi">256</span> <span class="o">+</span> <span class="mi">61</span>
<span class="go">1853</span>
</pre></div>
</div>
<p>That is, <em>d</em>.  Finally, we have <em>p</em> (151) and <em>q</em> (211), and three numbers (53, 173 and 73).</p>
<p>I believe from looking at the XML format that these last three are called DP, DQ and InverseQ, but I am not sure yet whether this is true, what that would mean in any case, or how they are used.  It certainly bears investigation.</p>
<p>We can also take a quick look at the public key type generated by <tt class="docutils literal"><span class="pre">openssh</span></tt>, which is slightly different.</p>
<p>This is the type that I analyzed in my blog posts:</p>
<p><a class="reference external" href="http://telliott99.blogspot.com/2011/08/dissecting-rsa-keys-in-python-2.html">http://telliott99.blogspot.com/2011/08/dissecting-rsa-keys-in-python-2.html</a></p>
<p>The <tt class="docutils literal"><span class="pre">openssh</span></tt> key is a full-length public key where the exponent <em>e</em> is known to be equal to 65537.</p>
<p>I split off the first and the last part (separated by spaces) by hand.  In Python:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">utils</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">data</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">load</span> <span class="n">data</span><span class="p">(</span><span class="s">&quot;kf.pub&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">data</span>
<span class="go">&#39;ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC8u8w9..&#39;</span>
</pre></div>
</div>
<p>The ellipsis indicates there&#8217;s a lot more data.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">data</span>
<span class="go">&#39;AAAAB3NzaC1yc2EAAAADAQABAAABAQC8u8w9K4aRPglzdPj..&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">base64</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">fn</span> <span class="o">=</span> <span class="s">&quot;out.txt&quot;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">FH</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="s">&quot;wb&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">FH</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">FH</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<p>In the bash shell</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>hexdump -C out.txt
00000000 00 00 00 07 73 73 68 2d 72 73 61 00 00 00 03 01 |....ssh-rsa.....|
..
</pre></div>
</div>
<p>A little redundant:  ssh-rsa again!  So the way this works is that the bytes following the decoded base64 that now says <tt class="docutils literal"><span class="pre">ssh-rsa</span></tt> are <tt class="docutils literal"><span class="pre">00</span> <span class="pre">00</span> <span class="pre">00</span> <span class="pre">03</span></tt>.  This is a 32-bit integer and it is a size, namely 3 bytes.  The instruction means that we are supposed to group the following three bytes.</p>
<p>We have next (if you could see the whole thing) <tt class="docutils literal"><span class="pre">01</span> <span class="pre">00</span> <span class="pre">01</span></tt> which is hexadecimal.  In decimal we get</p>
<div class="math">
\[1 \times 16^4 + 1 = 65537\]</div>
<p>Finally, we have <tt class="docutils literal"><span class="pre">00</span> <span class="pre">00</span> <span class="pre">01</span> <span class="pre">01</span></tt> which is hex for another size, 257 bytes, and that’s exactly how many there are left</p>
<p>In Python, again:</p>
<div class="highlight-python"><div class="highlight"><pre>&gt;&gt;&gt; data = load data(’out.txt’) &gt;&gt;&gt; data = data[22:]
&gt;&gt;&gt; len(data)
257
4￼
&gt;&gt;&gt; L = list(data)
&gt;&gt;&gt; L.reverse()
&gt;&gt;&gt; import struct
&gt;&gt;&gt; L2 = [struct.unpack(&quot;B&quot;,c)[0] for c in L]
&gt;&gt;&gt;
</pre></div>
</div>
<p>Here I forgot to use <tt class="docutils literal"><span class="pre">ord</span></tt> so we see a somewhat fancier way of decoding binary data byte by byte.  It amounts to the same thing, the bytes come out of <tt class="docutils literal"><span class="pre">unpack</span></tt> as ints.</p>
<p>We do a bit of fancy math to add up each int in the long number multiplied by the appropriate power of 256:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">b</span> <span class="o">=</span> <span class="mi">256</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">L2</span><span class="p">):</span>
<span class="gp">... </span><span class="n">x</span> <span class="o">*=</span> <span class="n">b</span><span class="o">**</span><span class="n">i</span>
<span class="gp">... </span><span class="n">n</span><span class="o">+=</span><span class="n">x</span>
<span class="gp">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">n</span> <span class="mf">23825407884424843043892774272494727.</span><span class="o">.</span>
</pre></div>
</div>
<p>Check it with <tt class="docutils literal"><span class="pre">rsa</span></tt></p>
<div class="highlight-python"><div class="highlight"><pre>&gt;&gt;&gt; import rsa
&gt;&gt;&gt; k = utils.load data(’kf’)
&gt;&gt;&gt; pk = rsa.PrivateKey.load_pkcs1(k)
&gt;&gt;&gt; pk.n 23825407884424843043892774272494727..
&gt;&gt;&gt; n == pk.n
True
&gt;&gt;&gt;
</pre></div>
</div>
<p>It matches!</p>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h4>Previous topic</h4>
  <p class="topless"><a href="openssl.html"
                        title="previous chapter">Example using openssl</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="formats.html"
                        title="next chapter">Standard key formats</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/structure.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="formats.html" title="Standard key formats"
             >next</a> |</li>
        <li class="right" >
          <a href="openssl.html" title="Example using openssl"
             >previous</a> |</li>
        <li><a href="index.html">MyCrypto 1.0 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2014, Tom Elliott.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>